## 7.3.4. 认购人与听众
JavaScript的CometD API有两个API与频道订阅工作：

的addListener（）和对应的removeListener（）

认购（）和记者退订（）

该的addListener（）方法：

必须用来听元信道的消息。

可以用来收听服务渠道的消息。

不应该被用来收听广播频道消息（使用认购（）代替）。

不涉及与贝叶服务器的任何通信，因此可以在调用之前调用握手（）。

是同步的：当它返回时，可以保证听者已添加。

该认购（）方法：

不得用于收听元频道消息（如果尝试时，服务器返回一个错误）。

可以用来收听服务渠道的消息。

应该用来收听广播信道消息。

涉及与贝叶服务器，因此可以在调用之前不能称之为通信握手（）。

是异步的：它会立即返回，贝叶服务器已收到订阅请求以及之前。

调用认购（） _不NOT_意味着你已经完成认购与服务器时函数返回。
如果你想成为某一服务器收到您的订购请求（或不），你可以注册一个/元/订阅监听器，或传递一个回调函数，以认购（） ：

cometd.subscribe（' /富'，函数（消息）{...}，函数（subscribeReply）
{
    如果（subscribeReply.successful）
    {
        / /服务器成功订阅此客户端的“/ foo”的通道。
    }
}）;
请记住，订阅可能在服务器上失败（例如，客户端没有足够的权限以认购）或客户机上（例如，有一个网络故障）。在这两种情况下，/元/订阅侦听器或回调函数，将与不成功的订阅消息回复调用。

你可以通过传递一个额外的对象来传递额外的信息的订阅消息订阅（）函数：

变种附加= {
    com.acme.priority：10
};
cometd.subscribe（' /富'，函数（消息）{...}，另外，函数（subscribeReply）
{
    / /在这里你的逻辑。 
}）;
记住，订阅一个频道的第一次，只有当订阅消息被发送到服务器。额外预订到相同的信道将不会导致一个消息被发送到服务器。也看到了javascript握手部分关于通过其他对象的详细信息。

两者的addListener（）和认购（）返回一个必须传递给分别认购对象removeListener（）和退订（） ：

/ /一些初始化代码
变种 subscription1 = cometd.addListener（' /元/连接'，函数（）{...}）;
 无功 subscription2 = cometd.subscribe（' /富/酒吧/ '，函数（）{.. 。}）;

/ /有的去初始化代码
cometd.unsubscribe（subscription2）;
cometd.removeListener（subscription1）;
功能退订（）也可以采取额外的对象和一个回调函数作为参数：

/ /一些初始化代码
变种 subscription1 = cometd.subscribe（' /富/酒吧/ '，函数（）{...}）;

/ /有的去初始化代码
变种附加= {
    com.acme.discard：真
}
cometd.unsubscribe（subscription1，另外，函数（unsubscribeReply）
{
    / /在这里你的逻辑。 
}）;
同样，以认购（） ，取消订阅消息被发送到从通道的最后一次退订只有当服务器。也看到了javascript握手部分关于通过其他对象的详细信息。

听众和用户之间的主要区别是，用户是在重新握手会自动删除，而听众不会被重新握手修改。当客户端预订通道，服务器维护一个客户特定的服务器端订阅状态。如果服务器需要重新握手，就意味着它失去了状态的客户端，因此也对服务器端的订阅状态。为了保持客户端的状态与服务器一致，用户 - 而不是听众 - 会自动在重新握手删除。

在代码的好地方执行订阅是在/元/握手功能。由于/元/握手监听器在两个明确的握手调用的客户端执行，并在重新握手的服务器触发器，这是保证您的预订总是正确执行，并保持与服务器的状态保持一致。

等价地，传递给握手方法的回调函数的行为完全像一个/元/握手监听器，因此可以用来进行订阅。

应用程序不需要退订的情况下重新握手; 该CometD库后，需要重新握手删除所有订阅的照顾，这样，当 /元/握手功能再次执行订阅是正确还原（不重复）。

出于同样的原因，你永远不应该增加一个监听器里面/元/握手 功能，因为这会增加另一个监听器无需拆卸前一个，导致同一消息的多个通知。

无功 _ReportListener;
cometd.addListener（' /元/握手'，函数（消息）
{
    / /只有订阅如果握手成功
    ，如果（message.successful）
    {
        / /批次所有订阅在一起 
        cometd.batch（函数（）
        {
            / /正确订阅广播频道 
            cometd.subscribe（' /会员'，功能（M）{...}）;

            / /正确的订阅服务渠道 
            cometd.subscribe（' /服务/状态'，功能（M）{...}）;

            / /凌乱到搬迁后新增的听众，喜欢用cometd.subscribe（...）
            如果（_ReportListener）
            {
                cometd.removeListener（_ReportListener）;
                _ReportListener = cometd.addListener（' /服务/报告'，功能（M）{...}）;
            }

            / /错误添加侦听器而不必去除 
            cometd.addListener（' /服务/通知'，功能（M）{...}）;
        }）;
    }
}）;
在情况下，贝叶服务器不可达（由于网络故障，或因为服务器崩溃），认购（）和退订（）的行为如下：

在认购（） CometD首先会将本地监听到用户该频道的列表，然后尝试将服务器的通信。如果通信失败，服务器不知道它有将邮件发送到该客户端，因此在客户端上，本地监听器（虽然现在）永远不会被调用。

在退订（），CometD先删除本地监听器从用户该频道的列表，然后尝试将服务器的通信。如果通信失败，服务器仍然将消息发送到客户端，但没有本地监听派遣到。
